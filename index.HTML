<!doctype html>
<html lang="en">
<head>
<script>window.SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzpRBmkOuXIfq9r3zeblMUfFTH7Ya7UaQhPgKuRBdfYgFRtM206XJoRLy4yxgpueXE/exec';</script>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Purchase Entry-2 Standalone Test (Patched)</title>
<style>
  /* Kept layout exactly as before — only script logic changed */
  body{font-family:Arial, Helvetica, sans-serif; margin:20px; background:#f2f2f2}
  #overlay_purchase_entry2{ position:relative; max-width:980px; margin:0 auto; background:#fff; border:3px solid #d9534f; box-shadow:0 8px 24px rgba(0,0,0,.2); padding:12px; border-radius:6px; }
  #overlay_purchase_entry2 h3{margin:0 0 8px 0}
  .row{display:flex; gap:8px; align-items:flex-end; margin-bottom:8px}
  select,input{padding:6px; font-size:14px}
  table{width:100%; border-collapse:collapse; margin-bottom:8px}
  th,td{border:1px solid #ddd; padding:6px; font-size:13px; text-align:left}
  .btn{padding:6px 10px; cursor:pointer; border-radius:4px; border:1px solid #666; background:#f7f7f7}
  .btn-primary{background:#0275d8; color:#fff; border-color:#0275d8}
</style>
</head>
<body>
<h2>Standalone Purchase Entry-2 Test (Patched)</h2>
<p>This file preserves your original layout and buttons. I applied the stable-table injection, totals calculation and submit wiring without changing the UI.</p>

<label for="scriptUrlInput">Set your deployed Apps Script web app URL (the EXEC URL):</label><br/>
<input id="scriptUrlInput" style="width:80%" placeholder="https://script.google.com/macros/s/XXXXXXXX/exec" /><button id="saveUrl" class="btn">Save</button>
<button id="autoFillExample" class="btn">Fill Example URL</button>
<p style="font-size:13px;color:#444">After setting the URL click <strong>Load Mandis</strong>. Then select mandi → date → Load Rows.</p>

<div id="overlay_purchase_entry2" aria-label="Purchase Entry 2 (Standalone)">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3>PURCHASE ENTRY-2 (Standalone Test)</h3>
  </div>

  <div class="row">
    <div style="min-width:280px;">
      <label for="pe2_mandi">Mandi</label><br/>
      <select id="pe2_mandi" style="width:260px;"><option value="">-- Load mandis first --</option></select>
    </div>
    <div style="min-width:180px;">
      <label for="pe2_date">Date</label><br/>
      <select id="pe2_date" style="width:160px;"><option value="">-- Select mandi --</option></select>
    </div>
    <div style="flex:1"></div>
    <div style="text-align:right;">
      <button id="pe2_loadMandis" class="btn">Load Mandis</button>
      <button id="pe2_load" class="btn btn-primary">Load Rows</button>
      <button id="pe2_reset" class="btn">Reset</button>
    </div>
  </div>

  <table id="pe2_table">
    <thead><tr><th>S.No.</th><th>Firm Name</th><th id="pe2_dynamic_headers"></th><th>Total Bags</th><th>Total Weight</th></tr></thead>
    <tbody id="pe2_body"></tbody>
    <tfoot id="pe2_tfoot"><tr><td colspan="5" style="text-align:right;font-weight:700">Subtotal</td><td id="pe2_sub_bags">0</td><td id="pe2_sub_w">0.00</td></tr></tfoot>
  </table>

  <div style="display:flex; gap:8px; justify-content:flex-end;">
    <button id="pe2_addrow" class="btn">+ Add Row</button>
    <button id="pe2_submit" class="btn btn-primary">Submit to ENTRIES</button>
  </div>

  <div id="pe2_status" style="margin-top:8px; font-weight:700;"></div>
  <div style="margin-top:8px; font-size:13px; color:#666">Console logs are helpful — open Developer Tools → Console to see request / response details.</div>
</div>

<!-- Preserved UI above. Script below contains the patched logic: stable injection, protection, totals and submit wiring. -->
<script>
// Minimal helper selectors
const sel = id => document.getElementById(id);
function toInt(v){ return Math.max(0, parseInt(String(v||'0').replace(/\D/g,''))||0); }

// Save/restore script URL (UI behavior preserved)
let SCRIPT_URL_LOCAL = '';
(function(){ const saved = localStorage.getItem('pe2_script_url'); if(saved){ document.getElementById('scriptUrlInput').value = saved; SCRIPT_URL_LOCAL = saved; }})();

document.getElementById('saveUrl').addEventListener('click', ()=>{
  const v = document.getElementById('scriptUrlInput').value.trim(); if(!v){ alert('Paste your script URL first'); return; }
  SCRIPT_URL_LOCAL = v.replace(/\/+$/, ''); localStorage.setItem('pe2_script_url', SCRIPT_URL_LOCAL); sel('pe2_status').textContent = 'Saved URL. Now click Load Mandis.';
});
document.getElementById('autoFillExample').addEventListener('click', ()=>{ document.getElementById('scriptUrlInput').value = 'https://script.google.com/macros/s/XXXXXXXX/exec'; });

// ------- Stable injector + totals + submit logic -------
const WPB = 0.375; const WEIGHT_DEC = 3;
function normalizeKey(s){ return String(s||'').replace(/[\uFEFF\u00A0]/g,'').replace(/[\x00-\x1F\x7F]/g,'').replace(/\./g,'').replace(/\s+/g,' ').trim().toUpperCase(); }
function parseNumber(x){ if(x===undefined||x===null) return 0; const n = Number(String(x).replace(/[^0-9.\-\.]/g,'')); return isNaN(n)?0:n; }
function toIso(s){ if(!s) return ''; if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; const m = String(s).match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})$/); if(m) return m[3]+'-'+m[2]+'-'+m[1]; const d=new Date(s); if(!isNaN(d.getTime())) return d.getFullYear()+'-'+('0'+(d.getMonth()+1)).slice(-2)+'-'+('0'+d.getDate()).slice(-2); return s; }

// safe decode helper to handle %20 and double-encoded %2520
function safeDecode(s){ if(!s) return ''; let out = String(s); try{ for(let i=0;i<2;i++){ if(/%[0-9A-Fa-f]{2}/.test(out)){ out = decodeURIComponent(out); } else break; } }catch(e){ return String(s); } return out; }

function findEntryTables(){ const all = Array.from(document.querySelectorAll('table')); const cand = all.filter(t => (t.innerText||'').toLowerCase().includes('firm name')); const seen=new Set(), out=[]; for(const t of cand){ const key=(t.id||'')+'|'+Math.round((t.getBoundingClientRect().top||0))+'|'+Math.round(((t.innerText||'').length||0)/30); if(!seen.has(key)){ seen.add(key); out.push(t); } } return out; }
function chooseBestTable(){ const c = findEntryTables(); if(!c.length) return null; const visible = c.filter(t=> t.offsetParent!==null); const pool = visible.length?visible:c; const withW = pool.find(t=> /Total Weight|Total Weight \(qtls\)/i.test((t.querySelector('thead')||{}).innerText||'')); if(withW) return withW; const withB = pool.find(t=> /Total Bags/i.test((t.querySelector('thead')||{}).innerText||'')); if(withB) return withB; return pool[0]; }

async function fetchRows(mandi, dateRaw){ if(!SCRIPT_URL_LOCAL && !window.SCRIPT_URL) { console.warn('SCRIPT_URL missing'); return []; } const base = SCRIPT_URL_LOCAL || window.SCRIPT_URL; if(!mandi||!dateRaw) return []; const iso = toIso(dateRaw); const tries = [[mandi,iso],[mandi,dateRaw],[encodeURIComponent(mandi),iso],[encodeURIComponent(mandi),dateRaw]]; for(const [m,d] of tries){ const url = base + '?action=getEntries2Rows&mandi=' + m + '&date=' + encodeURIComponent(d); try{ console.log('PE2 fetch ->', url); const txt = await fetch(url).then(r=>r.text()).catch(()=>null); if(!txt) continue; try{ const p = JSON.parse(txt); if(Array.isArray(p) && p.length) return p; if(p && Array.isArray(p.rows) && p.rows.length) return p.rows; }catch(e){ const a=txt.indexOf('['), b=txt.indexOf('{'); let sub=null; if(a>=0 && (a<b || b===-1)) sub = txt.slice(a); else if(b>=0) sub = txt.slice(b); if(sub) try{ const p2 = JSON.parse(sub); if(Array.isArray(p2) && p2.length) return p2; if(p2 && Array.isArray(p2.rows) && p2.rows.length) return p2.rows; }catch(e2){} } }catch(e){} } return []; }

function buildIntoTable(rows, tableEl){ if(!rows||!rows.length) return false; if(!tableEl||tableEl.tagName!=='TABLE') return false; const seen={}, order=[]; rows.forEach(r=>{ const raw=String(r.bardana||r.Bardana||''); raw.split(/[,|;]/).map(x=>x.trim()).filter(Boolean).forEach(orig=>{ const nk = normalizeKey(orig); if(!nk) return; if(!seen[nk]){ seen[nk]=orig; order.push(nk); } }); }); if(order.length===0){ console.warn('no bardana'); return false; } const labels = order.map(k=>seen[k]); let thead = tableEl.querySelector('thead'); if(!thead){ thead = document.createElement('thead'); tableEl.insertBefore(thead, tableEl.firstChild); } let tbody = tableEl.querySelector('tbody'); if(!tbody){ tbody = document.createElement('tbody'); tbody.id='pe2_body'; tableEl.appendChild(tbody); }
  const headParts = ['<th>S.No.</th>','<th>Firm Name</th>']; labels.forEach(h=> headParts.push('<th>' + h.replace(/&/g,'&amp;') + '</th>')); headParts.push('<th>Total Bags</th>','<th>Total Weight (qtls)</th>'); thead.innerHTML = '<tr>' + headParts.join('') + '</tr>';
  const byFirm={}; rows.forEach(r=>{ const firm=(r.firm||r.Firm||'').toString().trim(); if(!firm) return; byFirm[firm]=byFirm[firm]||{}; const bags = Number(r.bags||r.Bags||0)||0; const parts = String(r.bardana||r.Bardana||'').split(/[,|;]/).map(x=>x.trim()).filter(Boolean); if(parts.length<=1){ const lab = parts[0] ? (seen[normalizeKey(parts[0])]||parts[0]) : seen[order[0]]; byFirm[firm][lab] = (byFirm[firm][lab]||0) + bags; } else { const per = Math.floor(bags/parts.length); let rem = bags - per*parts.length; parts.forEach((p,i)=>{ const lab = seen[normalizeKey(p)]||p; byFirm[firm][lab] = (byFirm[firm][lab]||0) + per + (rem>0?1:0); if(rem>0) rem--; }); } });
  tbody.innerHTML = '';
  let idx = 0; Object.keys(byFirm).sort().forEach(f=>{ idx++; const per = byFirm[f]; let tr = '<tr>'; tr += '<td>' + idx + '</td>'; tr += '<td>' + f.replace(/&/g,'&amp;') + '</td>'; let firmBags = 0; labels.forEach(lbl=>{ const v = Number(per[lbl]||0); firmBags += v; tr += '<td><input class="pe2_bags_input" data-bardana="'+lbl.replace(/"/g,'&quot;')+'" value="'+v+'" style="width:80px"></td>'; }); tr += '<td class="pe2_row_total_bags">'+ firmBags +'</td>'; tr += '<td class="pe2_row_total_w">'+ (+(firmBags * WPB).toFixed(WEIGHT_DEC)) +'</td>'; tr += '</tr>'; tbody.insertAdjacentHTML('beforeend', tr); });
  Array.from(tbody.querySelectorAll('.pe2_bags_input')).forEach(inp=>{ if(inp._pe2_handler) inp.removeEventListener('input', inp._pe2_handler); const handler = function(){ const tr=this.closest('tr'); const sum = Array.from(tr.querySelectorAll('.pe2_bags_input')).reduce((s,e)=> s + (Number(e.value)||0), 0); tr.querySelector('.pe2_row_total_bags').textContent = sum; tr.querySelector('.pe2_row_total_w').textContent = (+(sum * WPB).toFixed(WEIGHT_DEC)); recalcAndAttachTotals(tableEl); }; inp._pe2_handler = handler; inp.addEventListener('input', handler); }); window._PE2_lastLabels = labels.slice(); window._PE2_latestRowsCache = rows.slice(); return true; }

function computeTotals(table){ const tbody = table.querySelector('tbody'); if(!tbody) return {bags:0, weight:0, indices:{}}; let totalBags=0; Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{ const rt = tr.querySelector('.pe2_row_total_bags'); if(rt){ totalBags += parseNumber(rt.textContent||rt.innerText); return; } const inputs = Array.from(tr.querySelectorAll('input.pe2_bags_input')); if(inputs.length){ totalBags += inputs.reduce((s,i)=> s + (parseNumber(i.value)||0), 0); return; } const tds = tr.querySelectorAll('td'); if(tds.length>=1){ const maybe = tds[tds.length-2].textContent||''; totalBags += parseNumber(maybe); } }); const totalWeight = +(totalBags * WPB).toFixed(WEIGHT_DEC); return {bags: totalBags, weight: totalWeight}; }

function upsertTotalsRow(table, totals){ if(!table) return; let tfoot = table.querySelector('tfoot'); if(!tfoot){ tfoot = document.createElement('tfoot'); table.appendChild(tfoot); } const colCount = (table.querySelector('thead')?.querySelectorAll('th').length) || (table.rows[0]?.cells.length) || 6; const cells = new Array(colCount).fill('').map(()=> '<td></td>'); const labelIdx = Math.max(0, colCount-2-1); const bagsIdx = colCount - 2; const weightIdx = colCount -1; cells[labelIdx] = '<td style="text-align:right; font-weight:700;">Grand Total</td>'; cells[bagsIdx] = '<td class="pe2_grand_total_bags" style="font-weight:700; text-align:center;"></td>'; cells[weightIdx] = '<td class="pe2_grand_total_w" style="font-weight:700; text-align:center;"></td>'; tfoot.innerHTML = '<tr>' + cells.join('') + '</tr>'; const tb = tfoot.querySelector('.pe2_grand_total_bags'); const tw = tfoot.querySelector('.pe2_grand_total_w'); if(tb) tb.textContent = totals.bags; if(tw) tw.textContent = (typeof totals.weight==='number')? totals.weight.toFixed(WEIGHT_DEC) : totals.weight; }

function recalcAndAttachTotals(table){ if(!table) return; const totals = computeTotals(table); upsertTotalsRow(table, totals); // also update simple footer cells if present
  const sBags = sel('pe2_sub_bags'); const sW = sel('pe2_sub_w'); if(sBags) sBags.textContent = totals.bags; if(sW) sW.textContent = totals.weight.toFixed ? totals.weight.toFixed(WEIGHT_DEC) : totals.weight; return totals; }

function protectTable(tableEl, opts={}){ if(!tableEl) return; if(tableEl._pe2_protected) return; tableEl._pe2_protected = true; let retries=0, maxRetries = opts.aggressive?40:8; const reapplyIfNeeded = ()=>{ const tb = tableEl.querySelector('tbody'); const needs = !tb || tb.children.length===0; const inputs = tb ? Array.from(tb.querySelectorAll('.pe2_bags_input')) : []; const allZero = inputs.length>0 && inputs.every(i=> Number(i.value) === 0); if((needs || (allZero && retries < maxRetries)) && (window._PE2_latestRowsCache||[]).length){ console.log('PE2 protect: reapplying cached rows (attempt', retries+1,')'); buildIntoTable(window._PE2_latestRowsCache, tableEl); recalcAndAttachTotals(tableEl); retries++; } }; let pulses=0, maxPulses = opts.aggressive?80:20; const pid = setInterval(()=>{ reapplyIfNeeded(); pulses++; if(pulses>=maxPulses) clearInterval(pid); }, 200); const mo = new MutationObserver(muts=>{ setTimeout(reapplyIfNeeded, 80); }); mo.observe(tableEl, { childList:true, subtree:true, characterData:true }); tableEl._pe2_mo = mo; console.log('PE2: protection installed on table', tableEl); }

async function tryBuildWithStability(rows, options={}){ const retryDelayMs = options.retryDelayMs||300; const stabilityChecks = options.stabilityChecks||3; const candidates = findEntryTables(); if(!candidates.length){ console.warn('no candidate entry table'); return false; } if(window._PE2_forcedTable){ const forced = window._PE2_forcedTable; let el=null; if(typeof forced==='number') el = candidates[forced]||null; else if(forced instanceof Element) el = forced; if(el){ buildIntoTable(rows, el); protectTable(el,{aggressive:false}); window._PE2_chosenTable = el; recalcAndAttachTotals(el); return true; } }
  for(let i=0;i<candidates.length;i++){ const t = candidates[i]; console.log('PE2: trying candidate', i, t); const ok = buildIntoTable(rows, t); if(!ok){ console.warn('build failed', i); continue; } let survived=true; for(let k=0;k<stabilityChecks;k++){ await new Promise(r=>setTimeout(r, retryDelayMs)); const inputs = Array.from(t.querySelectorAll('.pe2_bags_input')); if(inputs.length===0){ survived=false; break; } const allZero = inputs.every(inp=> Number(inp.value)===0); if(allZero){ survived=false; break; } } if(survived){ console.log('PE2: chosen stable table index', i); protectTable(t); window._PE2_chosenTable = t; recalcAndAttachTotals(t); return true; } else { try{ const tb = t.querySelector('tbody'); if(tb) tb.innerHTML=''; }catch(e){} } }
  console.warn('PE2: no stable table — injecting into first candidate aggressively'); const fallback = candidates[0]; buildIntoTable(rows, fallback); protectTable(fallback, {aggressive:true}); window._PE2_chosenTable = fallback; recalcAndAttachTotals(fallback); return true; }

function wrapLoadButtons(){ const candidates = Array.from(document.querySelectorAll('button,input[type=button]')).filter(b=>/(load|rows|mandis|entries)/i.test(((b.id||'')+' '+(b.textContent||'')+' '+(b.value||'')).toLowerCase())); const seen=new Set(); candidates.forEach(btn=>{ if(!btn||seen.has(btn)) return; seen.add(btn); if(btn._pe2_wrapped) return; btn._pe2_wrapped=true; const orig = btn.onclick; btn.onclick = function(evt){ try{ if(typeof orig === 'function') orig.call(this, evt); }catch(e){ console.warn('orig onclick error', e); } (async ()=>{ const mandiEl = sel('pe2_mandi'); const dateEl = sel('pe2_date'); const getText = el=>{ if(!el) return ''; const tag=(el.tagName||'').toUpperCase(); if(tag==='SELECT'){ const o=el.options[el.selectedIndex]; return (o && (o.textContent||o.value)) || el.value || ''; } if(tag==='INPUT' || tag==='TEXTAREA') return el.value || el.getAttribute('data-value') || ''; const aria = el.querySelector && el.querySelector('[aria-selected="true"],[aria-checked="true"]'); if(aria && aria.textContent) return aria.textContent.trim(); const selc = el.querySelector && el.querySelector('.selected, .is-selected, .active'); if(selc && selc.textContent) return selc.textContent.trim(); return (el.textContent||el.value||'').toString().trim(); };
    let mandi = getText(mandiEl) || ''; let dateRaw = getText(dateEl) || '';
    if(/loading/i.test(mandi) && mandiEl && mandiEl.tagName==='SELECT'){ const start=Date.now(); while(Date.now()-start < 2000){ mandi = getText(mandiEl) || ''; if(mandi && !/loading/i.test(mandi)) break; await new Promise(r=>setTimeout(r,180)); } }
    if(!mandi) mandi = prompt('Mandi not detected. Enter mandi name:')||''; if(!dateRaw) dateRaw = prompt('Date not detected. Enter date (DD-MM-YYYY or ISO):')||''; if(!mandi||!dateRaw){ console.warn('missing mandi/date — abort'); return; }
    console.log('PE2: Load clicked — fetching rows for', mandi, dateRaw);
    const rows = await (async ()=>{ try{ return await fetchRows(mandi, dateRaw); }catch(e){ console.warn('fetch failed', e); return []; } })(); if(!rows||!rows.length){ console.warn('PE2: no rows returned for', mandi, dateRaw); return; }
    await tryBuildWithStability(rows, { retryDelayMs:300, stabilityChecks:3 }); })(); };
    btn.addEventListener('click', ()=>{}, true);
    console.log('PE2: wrapped load-like button', btn);
  }); }

// ---- PATCHED overrideSubmit: added submit guard and safeDecode for mandi ----
function overrideSubmit(){
  const original = window.PE2_submitToEntries;
  const wrapped = async function(){
    if(window._PE2_submitting){ console.warn('PE2: submit already in progress - ignoring duplicate.'); return; }
    window._PE2_submitting = true;
    try{
      const table = window._PE2_chosenTable || chooseBestTable();
      if(!table){ alert('Submit failed: table not found'); return; }
      const tb = table.querySelector('tbody');
      if(!tb){ alert('Submit failed: table body missing'); return; }
      const labels = window._PE2_lastLabels || [];
      const payload = [];
      Array.from(tb.querySelectorAll('tr')).forEach(tr=>{
        const firm = (tr.children[1]?.querySelector('input.pe2_firm')?.value || tr.children[1]?.textContent || '').toString().trim();
        if(!firm) return;
        const inputs = Array.from(tr.querySelectorAll('input.pe2_bags_input'));
        inputs.forEach(inp=>{
          const bags = parseNumber(inp.value||0);
          if(bags<=0) return;
          const bardana = inp.getAttribute('data-bardana') || labels[0] || 'UNKNOWN';
          const date = (sel('pe2_date')?.value||'').toString().trim();
          const mandiRaw = (sel('pe2_mandi')?.value||'').toString().trim();
          const mandi = safeDecode(mandiRaw);
          payload.push({ date, mandi, firm, bardana, bags, weight: +(bags * WPB).toFixed(WEIGHT_DEC) });
        });
      });
      if(!payload.length){ alert('Nothing to submit — no bag counts found'); return; }
      const base = SCRIPT_URL_LOCAL || window.SCRIPT_URL;
      if(!base){ alert('SCRIPT_URL missing'); return; }
      const fd = new FormData();
      fd.append('action','savePurchaseFromIForm');
      fd.append('payload', JSON.stringify({ date: payload[0].date, mandi: payload[0].mandi, rows: payload }));
      console.log('PE2 submitting payload rows:', payload.length, payload.slice(0,10));
      const res = await fetch(base, { method:'POST', body: fd });
      const txt = await res.text();
      console.log('PE2 server response:', txt);
      alert('Submit complete — check console for server response.');
      if(typeof original === 'function'){ try{ original(); }catch(e){ console.warn('original submit threw', e); } }
    }catch(e){ console.error('PE2 submit error', e); alert('Submit failed — see console'); }
    finally{
      setTimeout(()=>{ window._PE2_submitting = false; }, 700);
    }
  };
  window.PE2_submitToEntries = wrapped;
  const submitBtns = Array.from(document.querySelectorAll('button,input[type=button]')).filter(b => /submit to entries|submit to ENTRIES|submit to entries/i.test((b.textContent||b.value||b.id||'')));
  submitBtns.forEach(btn=>{
    if(btn._pe2_submit_hook_installed) return;
    btn._pe2_submit_hook_installed = true;
    const handler = function(e){ e && e.preventDefault(); wrapped(); };
    btn.addEventListener('click', handler);
    btn._pe2_submit_hook = handler;
  });
  console.log('PE2: submit override installed.');
}

// ---- PATCHED submit_local: uses guard and safeDecode ----
async function submit_local(){
  if(window._PE2_submitting){ console.warn('PE2: submit already in progress - ignoring duplicate.'); return; }
  window._PE2_submitting = true;
  try{
    const table = window._PE2_chosenTable || chooseBestTable();
    if(!table){ sel('pe2_status').textContent='Submit failed: table not found'; return; }
    const tb = table.querySelector('tbody');
    if(!tb){ sel('pe2_status').textContent='Submit failed: no body'; return; }
    const labels = window._PE2_lastLabels || [];
    const payload = [];
    Array.from(tb.querySelectorAll('tr')).forEach(tr=>{
      const firm = (tr.children[1]?.querySelector('input.pe2_firm')?.value || tr.children[1]?.textContent||'').toString().trim();
      if(!firm) return;
      Array.from(tr.querySelectorAll('input.pe2_bags_input, input.pe2_bags')).forEach(inp=>{
        const bags = parseNumber(inp.value||0);
        if(bags<=0) return;
        const bardana = inp.getAttribute('data-bardana') || labels[0] || 'UNKNOWN';
        const date = (sel('pe2_date')?.value||'').toString().trim();
        const mandiRaw = (sel('pe2_mandi')?.value||'').toString().trim();
        const mandi = safeDecode(mandiRaw);
        payload.push({ date, mandi, firm, bardana, bags, weight: +(bags*WPB).toFixed(WEIGHT_DEC) });
      });
    });
    if(!payload.length){ sel('pe2_status').textContent='Nothing to submit'; return; }
    const base = SCRIPT_URL_LOCAL || window.SCRIPT_URL;
    if(!base){ sel('pe2_status').textContent='SCRIPT_URL missing'; return; }
    const fd = new FormData();
    fd.append('action','savePurchaseFromIForm');
    fd.append('payload', JSON.stringify({ date: payload[0].date, mandi: payload[0].mandi, rows: payload }));
    const res = await fetch(base, { method:'POST', body: fd });
    const txt = await res.text();
    console.log('submit response', txt);
    sel('pe2_status').textContent = 'Submit complete — check console.';
  }catch(e){ console.error(e); sel('pe2_status').textContent='Error submitting'; }
  finally{ setTimeout(()=>{ window._PE2_submitting = false; }, 700); }
}

// Expose helpers
window.PE2_tryInjectRows = async (rows) => { return tryBuildWithStability(rows, { retryDelayMs:300, stabilityChecks:3 }); };
window.PE2_forceTable = (tableOrIndex) => { window._PE2_forcedTable = tableOrIndex; console.log('PE2: forced table set', tableOrIndex); };
window.PE2_recalcTotals = () => { const t = window._PE2_chosenTable || chooseBestTable(); if(t){ const res = recalcAndAttachTotals(t); console.log('PE2_recalcTotals ->', res); return res; } console.warn('PE2_recalcTotals: no table'); return null; };

// Wire original UI buttons
async function loadMandis_local(){ const url = SCRIPT_URL_LOCAL || window.SCRIPT_URL; if(!url){ sel('pe2_status').textContent='Set SCRIPT URL above and Save.'; return; } sel('pe2_status').textContent='Loading mandis…'; sel('pe2_mandi').innerHTML = '<option>Loading…</option>'; try{ const res = await fetch(url + '?action=getEntries2Mandis'); const js = await res.json(); const mandis = (js && js.mandis)? js.mandis : []; sel('pe2_mandi').innerHTML = '<option value="">-- Select mandi --</option>' + mandis.map(m=>'<option value="'+encodeURIComponent(m)+'">'+m+'</option>').join(''); sel('pe2_status').textContent = 'Loaded ' + mandis.length + ' mandis.'; }catch(err){ console.error(err); sel('pe2_status').textContent='Error loading mandis. Check SCRIPT URL and deployment.'; } }
async function loadDates_local(){ const mandiEnc = sel('pe2_mandi').value; if(!mandiEnc){ sel('pe2_date').innerHTML = '<option value="">Select mandi first</option>'; return; } const mandi = safeDecode(mandiEnc); sel('pe2_status').textContent='Loading dates…'; sel('pe2_date').innerHTML = '<option>Loading…</option>'; try{ const res = await fetch((SCRIPT_URL_LOCAL||window.SCRIPT_URL) + '?action=getEntries2Dates&mandi=' + encodeURIComponent(mandi)); const js = await res.json(); const dates = (js && js.dates) ? js.dates : []; sel('pe2_date').innerHTML = dates.length ? dates.map(d=>'<option value="'+d+'">'+d+'</option>').join('') : '<option value="">No dates</option>'; sel('pe2_status').textContent = 'Loaded ' + dates.length + ' dates.'; }catch(err){ console.error(err); sel('pe2_status').textContent='Error loading dates.'; } }

async function loadRows_local(){ const mandiEnc = sel('pe2_mandi').value; const date = sel('pe2_date').value; if(!mandiEnc || !date){ sel('pe2_status').textContent = 'Select mandi & date'; return; } const mandi = safeDecode(mandiEnc); sel('pe2_status').textContent='Loading rows…'; try{ const rows = await fetchRows(mandi, date); if(!rows || !rows.length){ sel('pe2_status').textContent='No rows returned.'; return; } sel('pe2_body').innerHTML=''; await tryBuildWithStability(rows, { retryDelayMs:300, stabilityChecks:3 }); sel('pe2_status').textContent = 'Loaded rows: ' + ((rows && rows.length) ? rows.length : 0); }catch(err){ console.error(err); sel('pe2_status').textContent='Error loading rows; see console.'; } }

function addRow_local(prefill){ const bardanaList = window._PE2_lastLabels || ['37.5 KG JUTE NEW','JUTE PREVIOUS YEAR','37.5 KG MILLER BAG']; const tbody = sel('pe2_body'); const tr = document.createElement('tr'); const idx = tbody.children.length + 1; let cells = '<td>'+idx+'</td>'; cells += '<td><input class="pe2_firm" style="width:180px" value="'+(prefill?.firm||'')+'"></td>'; bardanaList.forEach(bt => { const v = prefill?.perType?.[bt] || 0; cells += '<td><input class="pe2_bags" data-bardana="'+bt+'" value="'+v+'" style="width:70px"></td>'; }); cells += '<td class="pe2_totalbags">0</td><td class="pe2_totalw">0.00</td>'; tr.innerHTML = cells + '<td><button class="pe2_del btn">Delete</button></td>'; tbody.appendChild(tr); tr.querySelector('.pe2_del').addEventListener('click', ()=>{ tr.remove(); recalc_local(); }); Array.from(tr.querySelectorAll('.pe2_bags')).forEach(inp=> inp.addEventListener('input', recalc_local)); recalc_local(); }

function recalc_local(){ let tb=0, tw=0; Array.from(document.querySelectorAll('#pe2_body tr')).forEach(tr=>{ const bags = Array.from(tr.querySelectorAll('.pe2_bags, .pe2_bags_input')).reduce((s,i)=> s + toInt(i.value), 0); const w = +(bags * WPB).toFixed(WEIGHT_DEC); const tbCell = tr.querySelector('.pe2_totalbags') || tr.querySelector('.pe2_row_total_bags'); if(tbCell) tbCell.textContent = bags; const twCell = tr.querySelector('.pe2_totalw') || tr.querySelector('.pe2_row_total_w'); if(twCell) twCell.textContent = w.toFixed(WEIGHT_DEC); tb += bags; tw += w; }); sel('pe2_sub_bags').textContent = tb; sel('pe2_sub_w').textContent = tw.toFixed(WEIGHT_DEC); const chosen = window._PE2_chosenTable || chooseBestTable(); if(chosen) recalcAndAttachTotals(chosen); }

// Wire original UI buttons
document.getElementById('pe2_loadMandis').addEventListener('click', loadMandis_local);
document.getElementById('pe2_load').addEventListener('click', loadRows_local);
document.getElementById('pe2_addrow').addEventListener('click', ()=> addRow_local({}));
document.getElementById('pe2_reset').addEventListener('click', ()=>{ sel('pe2_body').innerHTML=''; recalc_local(); sel('pe2_status').textContent=''; });
document.getElementById('pe2_submit').addEventListener('click', submit_local);
document.getElementById('pe2_mandi').addEventListener('change', loadDates_local);

// Install PE2 wrappers
wrapLoadButtons(); overrideSubmit();
// If cache exists, try to reapply
if(window._PE2_latestRowsCache && window._PE2_latestRowsCache.length){ tryBuildWithStability(window._PE2_latestRowsCache, { retryDelayMs:300, stabilityChecks:3 }); }
console.log('Patched PE2 standalone loaded — UI preserved.');
</script>
</body>
</html>
